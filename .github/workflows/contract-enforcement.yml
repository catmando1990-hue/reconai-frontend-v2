# Contract Enforcement - Frontend
# This workflow prevents silent contract drift for CORE, CFO, Intelligence, and GovCon APIs
#
# PART 3: Change Gate
# - Detects changes to API type definitions and hooks
# - Requires fixture updates when contracts change
# - Runs TypeScript compilation and tests

name: Contract Enforcement

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  contract-check:
    name: Contract Check (CORE + CFO + Intelligence + GovCon)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      # =========================================================================
      # CORE STATE CONTRACT ENFORCEMENT
      # =========================================================================

      - name: Check CORE contract files for changes
        id: core-contract-changes
        shell: bash
        run: scripts/ci/check-core-contract.sh

      - name: Verify CORE fixture updates for contract changes
        if: steps.core-contract-changes.outputs.contract_changed == 'true'
        run: |
          if [ "${{ steps.core-contract-changes.outputs.fixture_changed }}" != "true" ]; then
            echo "❌ BLOCKED: CORE contract changed but fixtures not updated!"
            echo ""
            echo "CORE State contract files were modified. Check for:"
            echo "  - src/hooks/useCoreState.tsx"
            echo "  - src/lib/api/types.ts"
            echo ""
            echo "You MUST update the test fixtures to match:"
            echo "  - tests/fixtures/core-state-factory.ts"
            echo ""
            exit 1
          fi
          echo "✅ CORE contract changed AND fixtures updated - compliance verified"

      # =========================================================================
      # CFO CONTRACT ENFORCEMENT
      # =========================================================================

      - name: Check CFO contract files for changes
        id: cfo-contract-changes
        run: |
          echo "Checking for CFO contract changes..."

          CFO_CONTRACT_CHANGED=false
          CFO_FIXTURE_CHANGED=false

          # Check if CFO hook changed
          if git diff --name-only HEAD~1 HEAD | grep -q "src/hooks/useCfoSnapshot.tsx"; then
            echo "Contract file changed: src/hooks/useCfoSnapshot.tsx"
            CFO_CONTRACT_CHANGED=true
          fi

          # Check if CFO types changed (types.ts contains CFO types)
          if git diff --name-only HEAD~1 HEAD | grep -q "src/lib/api/types.ts"; then
            echo "Types file changed (may contain CFO types): src/lib/api/types.ts"
            # Only flag as CFO change if CFO-related lines changed
            if git diff HEAD~1 HEAD -- src/lib/api/types.ts | grep -q -E "(Cfo|CFO)"; then
              CFO_CONTRACT_CHANGED=true
            fi
          fi

          # Check if fixture files changed
          if git diff --name-only HEAD~1 HEAD | grep -q "tests/fixtures/cfo-state-factory.ts"; then
            echo "Fixture file changed: tests/fixtures/cfo-state-factory.ts"
            CFO_FIXTURE_CHANGED=true
          fi

          echo "contract_changed=$CFO_CONTRACT_CHANGED" >> $GITHUB_OUTPUT
          echo "fixture_changed=$CFO_FIXTURE_CHANGED" >> $GITHUB_OUTPUT

      - name: Verify CFO fixture updates for contract changes
        if: steps.cfo-contract-changes.outputs.contract_changed == 'true'
        run: |
          if [ "${{ steps.cfo-contract-changes.outputs.fixture_changed }}" != "true" ]; then
            echo "❌ BLOCKED: CFO contract changed but fixtures not updated!"
            echo ""
            echo "CFO contract files were modified. Check for:"
            echo "  - src/hooks/useCfoSnapshot.tsx"
            echo "  - src/lib/api/types.ts (CFO types)"
            echo ""
            echo "You MUST update the test fixtures to match:"
            echo "  - tests/fixtures/cfo-state-factory.ts"
            echo ""
            exit 1
          fi
          echo "✅ CFO contract changed AND fixtures updated - compliance verified"

      # =========================================================================
      # INTELLIGENCE CONTRACT ENFORCEMENT
      # =========================================================================

      - name: Check Intelligence contract files for changes
        id: intelligence-contract-changes
        run: |
          echo "Checking for Intelligence contract changes..."

          INTEL_CONTRACT_CHANGED=false
          INTEL_FIXTURE_CHANGED=false

          # Check if Intelligence hook changed
          if git diff --name-only HEAD~1 HEAD | grep -q "src/hooks/useInsightsSummary.tsx"; then
            echo "Contract file changed: src/hooks/useInsightsSummary.tsx"
            INTEL_CONTRACT_CHANGED=true
          fi

          # Check if Intelligence types changed (types.ts contains Intelligence types)
          if git diff --name-only HEAD~1 HEAD | grep -q "src/lib/api/types.ts"; then
            echo "Types file changed (may contain Intelligence types): src/lib/api/types.ts"
            # Only flag as Intelligence change if Intelligence-related lines changed
            if git diff HEAD~1 HEAD -- src/lib/api/types.ts | grep -q -E "(Intelligence|Insight)"; then
              INTEL_CONTRACT_CHANGED=true
            fi
          fi

          # Check if fixture files changed
          if git diff --name-only HEAD~1 HEAD | grep -q "tests/fixtures/intelligence-state-factory.ts"; then
            echo "Fixture file changed: tests/fixtures/intelligence-state-factory.ts"
            INTEL_FIXTURE_CHANGED=true
          fi

          echo "contract_changed=$INTEL_CONTRACT_CHANGED" >> $GITHUB_OUTPUT
          echo "fixture_changed=$INTEL_FIXTURE_CHANGED" >> $GITHUB_OUTPUT

      - name: Verify Intelligence fixture updates for contract changes
        if: steps.intelligence-contract-changes.outputs.contract_changed == 'true'
        run: |
          if [ "${{ steps.intelligence-contract-changes.outputs.fixture_changed }}" != "true" ]; then
            echo "❌ BLOCKED: Intelligence contract changed but fixtures not updated!"
            echo ""
            echo "Intelligence contract files were modified. Check for:"
            echo "  - src/hooks/useInsightsSummary.tsx"
            echo "  - src/lib/api/types.ts (Intelligence types)"
            echo ""
            echo "You MUST update the test fixtures to match:"
            echo "  - tests/fixtures/intelligence-state-factory.ts"
            echo ""
            exit 1
          fi
          echo "✅ Intelligence contract changed AND fixtures updated - compliance verified"

      # =========================================================================
      # GOVCON CONTRACT ENFORCEMENT (DCAA Compliance)
      # =========================================================================

      - name: Check GovCon contract files for changes
        id: govcon-contract-changes
        run: |
          echo "Checking for GovCon/DCAA contract changes..."

          GOVCON_CONTRACT_CHANGED=false
          GOVCON_FIXTURE_CHANGED=false

          # Check if GovCon hook changed
          if git diff --name-only HEAD~1 HEAD | grep -q "src/hooks/useGovConSnapshot.tsx"; then
            echo "Contract file changed: src/hooks/useGovConSnapshot.tsx"
            GOVCON_CONTRACT_CHANGED=true
          fi

          # Check if GovCon types changed (types.ts contains GovCon types)
          if git diff --name-only HEAD~1 HEAD | grep -q "src/lib/api/types.ts"; then
            echo "Types file changed (may contain GovCon types): src/lib/api/types.ts"
            # Only flag as GovCon change if GovCon-related lines changed
            if git diff HEAD~1 HEAD -- src/lib/api/types.ts | grep -q -E "(GovCon|DCAA|Dcaa)"; then
              GOVCON_CONTRACT_CHANGED=true
            fi
          fi

          # Check if fixture files changed
          if git diff --name-only HEAD~1 HEAD | grep -q "tests/fixtures/govcon-state-factory.ts"; then
            echo "Fixture file changed: tests/fixtures/govcon-state-factory.ts"
            GOVCON_FIXTURE_CHANGED=true
          fi

          echo "contract_changed=$GOVCON_CONTRACT_CHANGED" >> $GITHUB_OUTPUT
          echo "fixture_changed=$GOVCON_FIXTURE_CHANGED" >> $GITHUB_OUTPUT

      - name: Verify GovCon fixture updates for contract changes
        if: steps.govcon-contract-changes.outputs.contract_changed == 'true'
        run: |
          if [ "${{ steps.govcon-contract-changes.outputs.fixture_changed }}" != "true" ]; then
            echo "❌ BLOCKED: GovCon/DCAA contract changed but fixtures not updated!"
            echo ""
            echo "GovCon contract files were modified. Check for:"
            echo "  - src/hooks/useGovConSnapshot.tsx"
            echo "  - src/lib/api/types.ts (GovCon types)"
            echo ""
            echo "You MUST update the test fixtures to match:"
            echo "  - tests/fixtures/govcon-state-factory.ts"
            echo ""
            echo "DCAA COMPLIANCE NOTICE: GovCon contract changes affect audit trail integrity."
            exit 1
          fi
          echo "✅ GovCon contract changed AND fixtures updated - DCAA compliance verified"

      # =========================================================================
      # TYPE CHECKING AND TESTS
      # =========================================================================

      - name: Run TypeScript compilation
        run: |
          echo "Running TypeScript type checking..."
          npx tsc --noEmit

      - name: Run Playwright tests
        run: |
          echo "Running Playwright E2E tests..."
          npx playwright install --with-deps chromium
          npx playwright test
