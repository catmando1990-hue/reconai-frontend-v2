# CORE State Contract Enforcement
# This workflow prevents silent contract drift between frontend and backend
#
# PART 3: Change Gate
# - Detects changes to /api/core/state contract files
# - Requires fixture updates when contract changes
# - Fails CI if contract changed but fixtures not updated

name: Contract Enforcement

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  contract-check:
    name: CORE State Contract Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 2  # Need history to detect changes

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check contract files for changes
        id: contract-changes
        run: |
          echo "Checking for CORE state contract changes..."

          # Files that define the contract
          CONTRACT_FILES=(
            "src/hooks/useCoreState.ts"
            "src/app/api/core/state/route.ts"
          )

          # Files that must be updated when contract changes
          FIXTURE_FILES=(
            "tests/fixtures/core-state-factory.ts"
          )

          CONTRACT_CHANGED=false
          FIXTURE_CHANGED=false

          # Check if any contract files changed
          for file in "${CONTRACT_FILES[@]}"; do
            if git diff --name-only HEAD~1 HEAD | grep -q "$file"; then
              echo "Contract file changed: $file"
              CONTRACT_CHANGED=true
            fi
          done

          # Check if fixture files changed
          for file in "${FIXTURE_FILES[@]}"; do
            if git diff --name-only HEAD~1 HEAD | grep -q "$file"; then
              echo "Fixture file changed: $file"
              FIXTURE_CHANGED=true
            fi
          done

          echo "contract_changed=$CONTRACT_CHANGED" >> $GITHUB_OUTPUT
          echo "fixture_changed=$FIXTURE_CHANGED" >> $GITHUB_OUTPUT

      - name: Verify fixture updates for contract changes
        if: steps.contract-changes.outputs.contract_changed == 'true'
        run: |
          if [ "${{ steps.contract-changes.outputs.fixture_changed }}" != "true" ]; then
            echo "❌ BLOCKED: Contract changed but fixtures not updated!"
            echo ""
            echo "CORE State contract files were modified:"
            echo "  - src/hooks/useCoreState.ts"
            echo "  - src/app/api/core/state/route.ts"
            echo ""
            echo "You MUST update the test fixtures to match:"
            echo "  - tests/fixtures/core-state-factory.ts"
            echo ""
            echo "This ensures all tests use the canonical schema."
            exit 1
          fi
          echo "✅ Contract changed AND fixtures updated - compliance verified"

      - name: Validate fixture schema matches contract
        run: |
          echo "Validating fixture schema..."

          # Check that factory exports expected functions
          if ! grep -q "export function coreStateFactory" tests/fixtures/core-state-factory.ts; then
            echo "❌ BLOCKED: coreStateFactory not exported from fixtures"
            exit 1
          fi

          if ! grep -q "export function assertValidCoreState" tests/fixtures/core-state-factory.ts; then
            echo "❌ BLOCKED: assertValidCoreState not exported from fixtures"
            exit 1
          fi

          # Check that SYNC_CONTRACT_VERSION is defined
          if ! grep -q "SYNC_CONTRACT_VERSION" tests/fixtures/core-state-factory.ts; then
            echo "❌ BLOCKED: SYNC_CONTRACT_VERSION not defined in fixtures"
            exit 1
          fi

          # Check that VALID_SYNC_STATUSES contains required values
          for status in "never" "running" "success" "failed"; do
            if ! grep -q "\"$status\"" tests/fixtures/core-state-factory.ts; then
              echo "❌ BLOCKED: VALID_SYNC_STATUSES missing '$status'"
              exit 1
            fi
          done

          echo "✅ Fixture schema validation passed"

      - name: Check for inline mocks in tests
        run: |
          echo "Checking for inline mocks that bypass factory..."

          # Pattern: inline object with sync.version or sync.status
          # This catches tests that create mocks without using factory
          VIOLATIONS=$(grep -rn "sync:\s*{" tests/*.spec.ts --include="*.ts" | grep -v "fixtures" | grep -v "import" | head -20 || true)

          if [ -n "$VIOLATIONS" ]; then
            echo "⚠️  WARNING: Potential inline mocks found (verify they use factory):"
            echo "$VIOLATIONS"
            echo ""
            echo "All tests should use canonical factory functions:"
            echo "  - emptyOrgState()"
            echo "  - partialOrgState()"
            echo "  - fullOrgState()"
            echo "  - withSyncRunning()"
            echo "  - withSyncFailed()"
            echo ""
            echo "If these are valid factory usages, this warning can be ignored."
          fi

          echo "✅ Inline mock check complete"

      - name: Run TypeScript check
        run: npx tsc --noEmit

      - name: Run tests with schema validation
        run: |
          echo "Running tests to verify schema assertions work..."
          # Run Playwright tests (they now include schema validation)
          npx playwright install --with-deps chromium
          npx playwright test tests/dashboard-home.spec.ts --project=desktop || {
            echo "❌ Tests failed - possible schema violation"
            exit 1
          }
          echo "✅ Tests passed with schema validation"
